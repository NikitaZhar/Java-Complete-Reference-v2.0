2025-10-07 17:44
Tags: #toFormat 

Синтаксическая грамматика — это **контекстно-свободная система правил**, описывающая, как токены составляются в конструкции языка Java.

В этом подразделе рассматриваются:

- базовые понятия КС-грамматики: терминалы, нетерминалы, продукции, целевой символ,
    
- нотация JLS (скобки, фигурные скобки, “one of”, “but not …”),
    
- целевой символ `CompilationUnit` и структура исходного файла,
    
- примеры разбора операторов (например, `if`, `for`),
    
- типичные синтаксические ловушки: dangling else, вложенные обобщения и др.,
    
- связь синтаксической грамматики с построением дерева AST и роль этой структуры в компиляторе.
    

Для разработчика этот материал особенно важен при работе с парсерами, при понимании ограничений структуры исходного файла и при отладке синтаксических ошибок.

## 1. Общая роль синтаксической грамматики

**Синтаксическая грамматика** Java описывает, как последовательность токенов (выделенных на лексическом этапе) преобразуется в **допустимую программу Java**.  
Она задаёт правила построения всех конструкций языка — выражений, операторов, объявлений, классов, интерфейсов, модулей.

> В JLS синтаксическая грамматика определена как **контекстно-свободная грамматика (КС-грамматика)**.  
> Целевой символ (goal symbol) для полной программы — **`CompilationUnit`**.

---

## 2. Контекстно-свободная грамматика и её элементы

### 2.1.1 Определение

Контекстно-свободная грамматика состоит из:

- **Нетерминалов** — абстрактных категорий (например, _Expression_, _Statement_).
    
- **Терминалов** — токенов, полученных из лексической грамматики (например, `if`, `for`, `+`, идентификаторы, литералы).
    
- **Продукций (правил)** — каждая связывает нетерминал с последовательностью терминалов и/или нетерминалов.
    
- **Целевого символа (goal symbol)** — нетерминала, с которого начинается разбор программы.
    

Программа считается корректной, если из целевого символа можно, применяя правила, получить последовательность терминалов, совпадающую с токенами исходного кода.

---

### 2.1.2 Нотация JLS

JLS использует особый формат для правил грамматики:

- Терминалы: моноширинный шрифт — например, `if`
    
- Нетерминалы: курсив — например, _Expression_
    
- `[ ... ]` — необязательная часть
    
- `{ ... }` — повторяемая часть (0 или более раз)
    
- “(one of)” — список альтернатив
    
- “but not …” — исключения
    

**Пример:**

```
IfThenStatement:
    `if` `(` Expression `)` Statement
```

---

### 2.1.3 CompilationUnit и структура исходного файла

Целевой символ синтаксической грамматики — **`CompilationUnit`**.  
Он описывает всю структуру Java-файла:

```
CompilationUnit:
    [PackageDeclaration]
    {ImportDeclaration}
    {TopLevelClassOrInterfaceDeclaration}
```

> Это означает, что файл может содержать:
> 
> 1. Необязательное объявление пакета.
>     
> 2. Произвольное количество импортов.
>     
> 3. Произвольное количество объявлений верхнеуровневых типов (классов, интерфейсов, enum, record).
>     

---

## 3. Как читать правила грамматики

### 3.1 Опциональные элементы

Пример правила для оператора `break`:

```
BreakStatement:
    `break` [Identifier] `;`
```

Значит, допустимы обе формы:

```java
break;
break outerLoop;
```

---

### 3.2 Повторяемые элементы

Пример правила для списка аргументов:

```
ArgumentList:
    Argument { , Argument }
```

Допустимы:

```java
f(x)
f(x, y)
f(x, y, z)
```

---

### 3.3 Композитные структуры

Пример правила для базового цикла `for`:

```
BasicForStatement:
    `for` `(` [ForInit] `;` [Expression] `;` [ForUpdate] `)` Statement
```

Возможны:

```java
for (int i=0; i<n; i++) { ... }
for (; i<n; i++) { ... }
for (int i=0;;) { ... }
for (;;) { ... }          // бесконечный цикл
```

---

## 4. Построение дерева разбора (AST)

Синтаксическая грамматика служит основой для построения **дерева синтаксического разбора** (AST), которое затем используется компилятором для:

- проверки семантики,
    
- оптимизаций,
    
- генерации байткода.
    

**Этапы разбора:**

1. Лексический анализ → токены.
    
2. Синтаксический анализ → AST.
    
3. Семантический анализ → проверки областей видимости, типов, definite assignment.
    
4. Генерация байткода.
    

---

## 5. Типичные синтаксические ловушки для программистов

### 5.1 Dangling else

Грамматика определяет, что `else` относится к ближайшему `if`:

```java
if (a)
    if (b) doSomething();
else
    doOther();   // относится к внутреннему if
```

> Для избежания двусмысленности всегда используйте фигурные скобки:

```java
if (a) {
    if (b) doSomething();
} else {
    doOther();
}
```

---

### 5.2 Проблемы с вложенными обобщениями и символами `>`

Современные версии Java корректно разбирают вложенные дженерики:

```java
List<List<Integer>> x = new ArrayList<>();
```

Но лишний `>` вызывает синтаксическую ошибку:

```java
List<List<Integer>>> y = null; // ошибка
```

---

### 5.3 Неполные выражения

Ошибки при нарушении правил грамматики выражений:

```java
int x = (1 + );  // ошибка: ожидается Expression после '+'
```

---

## 6. Связь грамматики и компилятора

Компилятор `javac` реализует синтаксический разбор строго по JLS.  
Некоторые инструменты (например, **ANTLR**, **JavaCC**) предоставляют открытые спецификации грамматики для создания собственных парсеров.

---

## 7. Схема процесса компиляции

```
Исходный текст
   ↓ (лексический анализ)
Токены
   ↓ (синтаксический разбор по КС-грамматике)
Дерево разбора (AST)
   ↓ (семантическая проверка)
Генерация байткода
```

---

## 8. Практические советы программистам

- Всегда следите за парностью скобок и структурой блоков.
    
- Используйте фигурные скобки даже при однострочных ветвях `if`, чтобы избежать dangling else.
    
- Проверяйте корректность вложенных дженериков.
    
- При работе с парсерами и статическим анализом опирайтесь на официальную грамматику JLS.
    

---

## 9. Ссылки на первоисточники

- [JLS §2.1 — The Syntactic Grammar](https://docs.oracle.com/javase/specs/jls/se23/html/jls-2.html)
    
- [JLS §7.3 — Compilation Units](https://docs.oracle.com/javase/specs/jls/se23/html/jls-7.html#jls-7.3)
    
- [ANTLR Grammar for Java](https://github.com/antlr/grammars-v4)
    

---

Хотите, чтобы я подготовил файл для скачивания **`2.1. The Syntactic Grammar.md`** с этим содержанием?
