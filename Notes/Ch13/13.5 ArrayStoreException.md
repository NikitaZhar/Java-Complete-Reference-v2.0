2025-11-04 13:06
Tags: #


- Причины (ковариантность), compile-time vs runtime.
    
- Примеры ×3 / ошибки ×2 / подводные камни.

### Формальное определение

- JLS: «An assignment to an array component (§15.13) throws an `ArrayStoreException` if the component‐type is a reference type and the value being assigned is not null and is not assignment-compatible with the component type.» ([Oracle Docs](https://docs.oracle.com/javase/specs/jls/se7/html/jls-10.html?utm_source=chatgpt.com "Chapter 10. Arrays"))
    

### Подтемы

5.1. Причины появления `ArrayStoreException`  
5.2. Различие между compile-time проверкой и runtime исключением  
5.3. Примеры с ковариантностью массивов

### Развёрнутое пояснение

**5.1 Причины:**  
Массив ссылочного типа `T[]` допускает хранение ссылок на объекты типа `T` или его подтипов, либо `null`. Если массив был создан как `S[]` где `S` – подтип `T` (например `String[]` как `Object[]`), компилятор может разрешить присваивание из-за ковариантности, но во время выполнения фактический массив ожидает именно `S`, и если присваивается другой тип (например `Integer`), возникает `ArrayStoreException`.  
**5.2 Compile-time vs runtime:**  
Компилятор допускает присваивание потому что проверяет по типу переменной (e.g., `Object[]`). Но фактический массив имеет тип `String[]`, и runtime проверка приводит к исключению.  
**5.3 Примеры с ковариантностью:**  
`String[] sa = new String[5]; Object[] oa = sa; oa[0] = new Integer(123); // ArrayStoreException at runtime`.

### Примеры (корректные)

```java
// Пример 1
String[] sa = new String[2];
Object[] oa = sa;
oa[0] = "Hello";

// Пример 2
Number[] na = new Integer[3];    // допустимо (Integer[] → Number[])
na[0] = Integer.valueOf(10);

// Пример 3
Object[] oa2 = new Object[4];
oa2[0] = new String("X");
oa2[1] = Integer.valueOf(5);
```

### Примеры (ошибочные)

```java
// Ошибка 1
String[] sa2 = new String[3];
Object[] oa2 = sa2;
oa2[0] = new Integer(5);         // runtime: ArrayStoreException

// Ошибка 2
Number[] nb = new Integer[2];
nb[0] = Double.valueOf(3.14);    // compile-time: допустимо, но runtime: ArrayStoreException
```

### Типичные ошибки и подводные камни

- Подводный камень: считать, что массивы ссылочных типов благодаря ковариантности полностью безопасны – нет, возможен `ArrayStoreException`.
    
- Ошибка: игнорировать, что тип массива при создании фиксирован (например `new Integer[5]`), даже если переменная имеет тип `Number[]`.
    
- При использовании generic + массивов (например `List<String>[]`) ситуация усложняется – избегайте подобных конструкций.
    
